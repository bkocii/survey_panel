{% extends "admin/wizard_base.html" %}
{% load static %}
{% load tailwind_tags %}


{% block content %}
<script>
  window.LOGIC_QUESTIONS = {{ logic_questions_json|safe }};
</script>


<section class="min-h-screen w-full px-6 py-8 bg-gray dark:bg-gray-900">


  <div class="flex flex-col lg:flex-row gap-8 max-w-screen-xl mx-auto min-h-screen">
      <!-- LEFT: FORM (spans 2 cols) -->
      <div class="lg:w-2/3 w-full min-w-0">
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">{{ title }}</h1>
        <br>

          {# Toasts ‚Äî top-right, auto-dismiss #}
        <div id="toast-stack" class="fixed right-4 top-4 z-[60] space-y-2"></div>

        <script>
          // Define makeToast globally if it doesn't exist
          (function () {
            if (window.makeToast) return;
            function ensureStack() {
              let stack = document.getElementById('toast-stack');
              if (!stack) {
                stack = document.createElement('div');
                stack.id = 'toast-stack';
                stack.className = 'fixed right-4 top-4 z-[60] space-y-2';
                document.body.appendChild(stack);
              }
              return stack;
            }
            window.makeToast = function (text, level) {
              const stack = ensureStack();
              const map = {
                success: { cls: 'toast toast-success',  icon: '‚úîÔ∏è' },
                error:   { cls: 'toast toast-error',    icon: '‚õî' },
                warning: { cls: 'toast toast-warning',  icon: '‚ö†Ô∏è' },
                info:    { cls: 'toast toast-info',     icon: '‚ÑπÔ∏è' },
                debug:   { cls: 'toast toast-debug',    icon: 'üêû' },
                default: { cls: 'toast',                icon: '‚Ä¢'  },
              };
              const m = map[level] || map.default;
              const el = document.createElement('div');
              el.className = m.cls + ' toast-enter';
              el.innerHTML = `
                <div class="toast-inner">
                  <span class="toast-icon" aria-hidden="true">${m.icon}</span>
                  <div class="toast-text" role="${level === 'error' ? 'alert' : 'status'}">${text}</div>
                  <button type="button" class="toast-close" aria-label="Dismiss">‚úñ</button>
                </div>`;
              stack.appendChild(el);
              requestAnimationFrame(() => el.classList.remove('toast-enter'));
              const kill = () => { el.classList.add('toast-leave'); setTimeout(() => el.remove(), 200); };
              const timer = setTimeout(kill, 5000);
              el.querySelector('.toast-close')?.addEventListener('click', () => { clearTimeout(timer); kill(); });
            };
          })();
        </script>

      {% if messages %}
        <script>
          (function () {
            {% for message in messages %}
              makeToast("{{ message|escapejs }}", "{{ message.tags|default:'info' }}");
            {% endfor %}
          })();
        </script>
        {% endif %}


      <br>

        <form method="post" enctype="multipart/form-data" id="question-form" class="space-y-6">
          {% csrf_token %}
          {% if editing %}
              <input type="hidden" id="edit_id" name="edit_id" value="{{ editing.id }}">
            {% endif %}

            {# Hidden pool of options for "next_question" selects #}
            <select id="next-question-options" class="hidden" aria-hidden="true" tabindex="-1">
              <option value="">---------</option>
              {# Use whatever you already pass; adjust the loop if your var name differs #}
              {% for q in all_questions %}
                <option value="{{ q.id }}">{{ q.text|truncatewords:10 }}</option>
              {% endfor %}
            </select>

          {{ form.non_field_errors }}

            {# Row 1: Code (narrow) | Question type | Lookup #}
            <div id="wizard-row-1" class="flex items-end gap-8 mb-4">

              {# Code ‚Äî narrow, non-growing #}
              <div class="question-field code-field flex-none">
                <label for="{{ form.code.id_for_label }}" class="block text-sm font-medium text-white dark:text-gray-300 mb-1">
                  Code
                </label>
                {{ form.code }}
              </div>

              {# Question type ‚Äî grows to fill the middle #}
              <div class="question-field question_type-field flex-1 min-w-0">
                <label for="{{ form.question_type.id_for_label }}" class="block text-sm font-medium text-white dark:text-gray-300 mb-1">
                  Question type
                </label>
                {{ form.question_type }}
              </div>

              {# Lookup ‚Äî fixed width, pushed to the far right #}
              <div id="question_lookup_container"
                   class="lookup-field flex-none w-80 ml-auto"
                   data-endpoint="{% url 'surveys:admin_question_lookup' %}">
                <label for="question_lookup_search" class="block text-sm font-medium text-white dark:text-gray-300 mb-1">
                  Clone Existing Question
                </label>
                <div class="relative">
                  <input id="question_lookup_search" type="text" autocomplete="off"
                         placeholder="Type code or text to search‚Ä¶"
                         class="block w-full rounded border border-gray-300 bg-white shadow-sm
                                focus:border-indigo-500 focus:ring-indigo-500
                                dark:bg-gray-800 dark:text-gray-100 dark:border-gray-700"
                         aria-autocomplete="list" aria-controls="question_lookup_results" aria-expanded="false" />
                  <ul id="question_lookup_results"
                      class="absolute z-20 mt-1 w-full max-h-60 overflow-auto rounded-md border border-gray-200 bg-white shadow-lg
                             dark:bg-gray-900 dark:border-gray-700 hidden"
                      role="listbox"></ul>
                  <select id="question_lookup" class="hidden"><option value=""></option></select>
                </div>
              </div>
            </div>

            {# Row 2: Question text (fills) | Required switch (small, right) #}
            <div id="wizard-row-2" class="flex flex-col md:flex-row md:items-end gap-6 md:gap-8 mt-10 mb-0">

              {# Question text ‚Äî grows; full width on small, wide on md+ #}
              <div class="question-field text-field md:flex-1 min-w-0">
                <label for="{{ form.text.id_for_label }}" class="block text-sm font-medium text-white dark:text-gray-300 mb-1">
                  Question text
                </label>
                <div class="w-full">
                  {{ form.text }}
                </div>
                {% if form.text.help_text %}
                  <p class="text-xs text-white/80 dark:text-gray-400 mt-1">{{ form.text.help_text }}</p>
                {% endif %}
                {% for error in form.text.errors %}<p class="text-sm text-red-600">{{ error }}</p>{% endfor %}
              </div>

              {# Required ‚Äî fixed/compact on the right #}
              <div class="question-field required-field md:flex-none md:w-48 md:ml-auto">
                <label for="{{ form.required.id_for_label }}" class="block text-sm font-medium text-white dark:text-gray-300 mb-1">
                  Required
                </label>
                <div class="h-10 flex items-center justify-end">
                  {{ form.required }}
                </div>
                {% for error in form.required.errors %}<p class="text-sm text-red-600">{{ error }}</p>{% endfor %}
              </div>

            </div>

            {# Row 3: Helper text (1/2) | Media type + Upload (1/2) #}
            <div id="wizard-row-3" class="flex flex-col md:flex-row md:flex-wrap md:items-end gap-6 mt-0">

              {# Helper text ‚Äî half #}
              <div class="question-field helper_text-field compact md:basis-1/2 md:flex-[0_0_45%] min-w-0">
                <label for="{{ form.helper_text.id_for_label }}"
                       class="block text-xs font-medium text-white dark:text-gray-300 mb-0.5">
                  Helper text
                </label>
                <div class="w-full">{{ form.helper_text }}</div>
                {% if form.helper_text.help_text %}
                  <p class="text-[11px] leading-4 text-white/80 dark:text-white mt-1">{{ form.helper_text.help_text }}</p>
                {% endif %}
                {% for error in form.helper_text.errors %}<p class="text-sm text-red-600">{{ error }}</p>{% endfor %}
              </div>

              {# Media type ‚Äî quarter #}
              <div class="question-field helper_media_type-field compact md:basis-1/4 md:flex-[0_0_30%] min-w-0">
                <label for="{{ form.helper_media_type.id_for_label }}"
                       class="block text-xs font-medium text-white dark:text-gray-300 mb-0.5">
                  Media type
                </label>
                <div class="w-full">{{ form.helper_media_type }}</div>
                {% for error in form.helper_media_type.errors %}<p class="text-sm text-red-600">{{ error }}</p>{% endfor %}
              </div>

              {# Upload ‚Äî quarter #}
              <div class="question-field helper_media-field compact md:basis-1/4 md:flex-[0_0_25%] min-w-0">
                <label for="{{ form.helper_media.id_for_label }}"
                       class="block text-xs font-medium text-white dark:text-gray-300 mb-0.5">
                  Helper media
                </label>
                <div class="w-full">{{ form.helper_media }}</div>
                {% if form.helper_media.help_text %}
                  <p class="text-[11px] leading-4 text-white/80 dark:text-gray-400 mt-1">{{ form.helper_media.help_text }}</p>
                {% endif %}
                {% for error in form.helper_media.errors %}<p class="text-sm text-red-600">{{ error }}</p>{% endfor %}
              </div>

            </div>

            <div class="question-field visibility_rules-field mt-4">
              <label class="block text-sm font-medium text-white dark:text-gray-300">
                Display logic
              </label>

              <div class="flex flex-col gap-2 md:flex-row md:items-start">
                {{ form.visibility_rules }}

                <button
                  type="button"
                  id="open-logic-builder"
                  class="btn-shell mt-2 md:mt-0"
                  data-builder-target="id_visibility_rules"
                >
                  <span class="btn-ui btn-secondary whitespace-nowrap">
                    üß© Build display logic
                  </span>
                </button>
              </div>

              <p class="text-xs text-white/80 dark:text-white mt-1">
                You can still edit raw JSON if you like.
                Example: <code>{"all":[{"q":"Q1","op":"eq","val":1}]}</code>
              </p>
            </div>

            {# NEW: include the modal #}
            {% include "admin/surveys/includes/partials/logic_builder_modal.html" %}


            {% for field in form %}
              {% if field.name != 'code' and field.name != 'text' and field.name != 'question_type' and field.name != 'required' and field.name != 'helper_text' and field.name != 'helper_media' and field.name != 'helper_media_type' and field.name != 'next_question' and field.name != 'visibility_rules'%}
                <div class="mt-4 question-field {{ field.name }}-field">
                  <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-white dark:text-gray-300">
                    {{ field.label }}
                  </label>
                  {{ field }}
                  {% if field.help_text %}<p class="text-xs text-white/80 dark:text-gray-400">{{ field.help_text }}</p>{% endif %}
                  {% for error in field.errors %}<p class="text-sm text-red-600">{{ error }}</p>{% endfor %}
                </div>
              {% endif %}
            {% endfor %}

            <br>

          {% include 'admin/surveys/includes/inlines.html' %}

            <div id="wizard-actions" class="mt-8 flex flex-wrap gap-3 justify-between items-center">
              <a href="{% url 'admin:surveys_survey_change' survey.id %}" class="btn-link" role="button">
                <span class="btn-ui btn-secondary">‚Üê Back to survey</span>
              </a>

                <button type="button" id="clear-wizard-btn" class="btn-shell" title="Clear fields and inlines">
                  <span class="btn-ui btn-secondary">üßπ Clear wizard</span>
                </button>


              {% if editing %}
                  <input type="hidden" name="edit_id" value="{{ editing.id }}">

                  <button type="submit" name="update_question" value="1" class="btn-shell">
                    <span class="btn-ui btn-primary">üíæ Update Question</span>
                  </button>

                  <button type="submit" name="cancel_editing" value="1" formnovalidate class="btn-shell">
                    <span class="btn-ui btn-secondary">‚úñ Cancel Editing</span>
                  </button>
                {% else %}
                  <button type="submit" name="save_question" value="1" class="btn-shell">
                    <span class="btn-ui btn-primary">üíæ Save Question</span>
                  </button>
                {% endif %}
            </div>

        </form>

        {% include "admin/surveys/includes/partials/bulk_add_modal.html" %}
        {% include "admin/surveys/includes/partials/confirm_switch_modal.html" %}
        {% include "admin/surveys/includes/partials/confirm_delete_modal.html" %}
        {% include "admin/surveys/includes/partials/routing_modal.html" %}


      <form id="wizard-delete-form" method="post" style="display:none;">
          {% csrf_token %}
          <input type="hidden" name="delete_id" id="wizard-delete-id">
        </form>


      </div>
        <template id="preview-placeholder">
          <em class="placeholder text-indigo-400 dark:text-indigo-300 italic">
            Start typing or adding options to see a live preview...
          </em>
        </template>
      <!-- RIGHT: LIVE PREVIEW (1 col) -->

    {{ all_question_ids|json_script:"wizard-qids" }}


      <div class="lg:w-1/3 w-full border-l lg:pl-6 mt-8 lg:mt-0 min-w-0">
          <div class="preview-sticky lg:sticky lg:top-4 self-start">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center justify-between">
              <span>üîç Live Preview</span>
              <a href="{% url 'surveys:survey_preview' survey.id %}" target="_blank" class="btn-shell" title="Open live preview">
                  <span class="btn-ui btn-secondary">üëÄ Preview Survey</span>
                </a>
            </h2>
            <div id="question-preview-list"
                 class="bg-slate-900/60 backdrop-blur border border-slate-800 rounded-2xl p-4 text-sm text-slate-200 overflow-y-auto"
                 data-api-base="/surveys/api/question-data/"
                 data-preview-api-base="/surveys/api/question-preview/"
                 data-reorder-endpoint="{% url 'surveys:surveys_reorder' survey.id %}">
              <!-- Cards inserted by JS -->
            </div>
          </div>

          <script>
          (function () {
            const el = document.getElementById('wizard-qids');
            window.SurveyWizard = window.SurveyWizard || {};
            window.SurveyWizard.initialIds = el ? JSON.parse(el.textContent || '[]') : [];
          })();
        </script>

          <script src="{% static 'admin/js/wizard/preview.js' %}"></script>

          <script>
            (function () {
              function sizePreview() {
                var sticky = document.querySelector('.preview-sticky');
                if (!sticky) return;

                // Distance from top of viewport; when sticky is pinned this ~ equals the 'top' offset.
                var top = sticky.getBoundingClientRect().top;

                // Leave a little breathing room at the bottom (16px).
                var available = window.innerHeight - top - 16;
                if (available > 0) {
                  sticky.style.height = available + 'px';
                  // Ensure the inner list uses the full height
                  var list = document.getElementById('question-preview-list');
                  if (list) list.style.height = '100%';
                }
              }

              // Throttle scroll handler for performance
              var ticking = false;
              function onScrollResize() {
                if (!ticking) {
                  window.requestAnimationFrame(function () {
                    sizePreview();
                    ticking = false;
                  });
                  ticking = true;
                }
              }

              document.addEventListener('DOMContentLoaded', sizePreview);
              window.addEventListener('resize', onScrollResize);
              window.addEventListener('scroll', onScrollResize, { passive: true });

              // One more pass after fonts/layout settle
              setTimeout(sizePreview, 0);
            })();
            </script>

      </div>


  </div>

</section>

{% endblock %}
