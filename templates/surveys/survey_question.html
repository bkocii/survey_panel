{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block head_title %}
survey
{% endblock head_title %}


{% block content %}

<div class="container mt-5">
    <div class="q-card">
        <div class="q-title">
          <h3 class="q-title mb-0">{{ current_index }}. {{ question.text }}</h3>
        </div>

        {% if question.helper_text %}
          <p class="q-helper"><em>{{ question.helper_text|linebreaksbr|safe }}</em></p>
        {% endif %}

        {% if question.helper_media and question.helper_media_type %}
          <div class="q-media mb-3">
            {% if question.helper_media_type == 'image' %}
              <img src="{{ question.helper_media.url }}" alt="Helper Image">
            {% elif question.helper_media_type == 'video' %}
              <video controls style="max-width:100%; height:auto;">
                <source src="{{ question.helper_media.url }}" type="video/mp4">
              </video>
            {% elif question.helper_media_type == 'audio' %}
              <audio controls>
                <source src="{{ question.helper_media.url }}" type="audio/mpeg">
              </audio>
            {% endif %}
          </div>
        {% endif %}

        {% if messages %}
          <div class="alert alert-danger mt-2 mb-3">
            {% for message in messages %}
              <div>{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="q-body">
          {% csrf_token %}

        <div class="q-quest q-body q-card__content">
        {% comment %} Old giant IF/ELIF block replaced by a partial {% endcomment %}
        {% include "surveys/_question_display.html" with question=question preview=False grouped_matrix_columns=grouped_matrix_columns %}
        </div>

        <script>
          document.addEventListener("DOMContentLoaded", function () {
            const fp = flatpickr(".date-input", {
              dateFormat: "Y-m-d"
            });

            document.querySelectorAll(".calendar-btn").forEach(btn => {
              btn.addEventListener("click", function () {
                const input = btn.previousElementSibling;
                input.focus(); // open the date picker
              });
            });
          });
        </script>

        {# actions row just ABOVE the progress bar #}
        <div class="q-card__actions pb-2 flex gap-2">
          <button type="submit"
                  name="nav"
                  value="back"
                  formnovalidate
                  class="btn-shell">
            <span class="btn-ui btn-primary btn-wide">‚¨ÖÔ∏è Back</span>
          </button>

          <button type="submit"
                  name="nav"
                  value="next"
                  class="btn-shell">
            <span class="btn-ui btn-primary btn-wide">‚û°Ô∏è Next</span>
          </button>
        </div>
            {# place this as the LAST element inside your card #}
        </form>

        <div class="q-card__footer">
          <div class="q-progress"
               role="progressbar"
               aria-label="Survey progress"
               aria-valuenow="{{ progress_percent }}"
               aria-valuemin="0"
               aria-valuemax="100">
            <div class="q-progress__bar" style="width: {{ progress_percent }}%;"></div>
            <span class="q-progress__text">{{ current_index }} of {{ total_questions }}</span>
          </div>
        </div>

    {% if time_left %}
        <div id="survey-timer" class="alert alert-warning">
            Time left: <span id="survey-time">{{ time_left }}</span> seconds
        </div>
        <script>
          let surveyTime = {{ time_left }};
          const surveyInterval = setInterval(() => {
            surveyTime--;
            document.getElementById("survey-time").innerText = surveyTime;
            if (surveyTime <= 0) {
              clearInterval(surveyInterval);
              alert("Time is up! Submitting your survey.");
              window.location.href = "{% url 'surveys:survey_submit' survey.id %}";
            }
          }, 1000);
        </script>
    {% endif %}

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const latInput = document.getElementById('latitude');
        const lngInput = document.getElementById('longitude');

        // Default center (Tirana)
        let initialLat = 41.3275;
        let initialLng = 19.8189;
        let initialZoom = 13;

        // üÜï If we already have saved coords, start from there
        if (latInput && lngInput && latInput.value && lngInput.value) {
          initialLat = parseFloat(latInput.value);
          initialLng = parseFloat(lngInput.value);
          initialZoom = 15;
        }

        const map = L.map('map').setView([initialLat, initialLng], initialZoom);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let marker = null;

        function setLocation(lat, lng) {
          document.getElementById('locationInput').value = `${lat},${lng}`;
          document.getElementById('latitude').value = lat;
          document.getElementById('longitude').value = lng;
        }

        function addMarker(lat, lng) {
          if (marker) {
            map.removeLayer(marker);
          }
          marker = L.marker([lat, lng]).addTo(map);
          setLocation(lat, lng);
        }

        // üÜï If we had coords (going back), drop the initial marker
        if (latInput && lngInput && latInput.value && lngInput.value) {
          addMarker(parseFloat(latInput.value), parseFloat(lngInput.value));
        }

        // Add marker on map click
        map.on('click', function (e) {
          const { lat, lng } = e.latlng;
          addMarker(lat, lng);
        });

        // Add geocoder control
        const geocoder = L.Control.geocoder({
          defaultMarkGeocode: false,
          placeholder: "Search for a location‚Ä¶",
          collapsed: false
        })
        .on('markgeocode', function (e) {
          const latlng = e.geocode.center;
          map.setView(latlng, 15);
          addMarker(latlng.lat, latlng.lng);
        })
        .addTo(map);

        // üÜï Move geocoder box to top-left safely
        const geocoderEl = document.querySelector('.leaflet-control-geocoder');
        if (geocoderEl) {
          geocoderEl.classList.add('leaflet-top', 'leaflet-left');
        }
      });
    </script>

</div>
</div>

{% endblock %}

