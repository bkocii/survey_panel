{% extends 'base.html' %}
{% load custom_filters %}
{% block head_title %}
survey
{% endblock head_title %}


{% block content %}

<div class="container mt-5">

        {% comment %} Old giant IF/ELIF block replaced by a partial {% endcomment %}
        {% include "surveys/_question_display.html" with question=question preview=False grouped_matrix_columns=grouped_matrix_columns %}


                <!-- “Other” input field -->
        <div id="other-input" style="display: none;" class="mt-3">
            <label for="other_text">Please specify:</label>
            <input type="text" name="other_text" id="other_text" class="form-control">
        </div>

        <script>
        function toggleOther(input) {
            const otherDiv = document.getElementById('other-input');
            const selectedText = (
                input.tagName === 'SELECT'
                    ? input.options[input.selectedIndex].text
                    : input.nextSibling.textContent || ''
            ).trim().toLowerCase();

            if (selectedText === 'other') {
                otherDiv.style.display = 'block';
            } else {
                otherDiv.style.display = 'none';
                document.getElementById('other_text').value = '';
            }
        }
        </script>


        <script>
          document.addEventListener("DOMContentLoaded", function () {
            const fp = flatpickr(".date-input", {
              dateFormat: "Y-m-d"
            });

            document.querySelectorAll(".calendar-btn").forEach(btn => {
              btn.addEventListener("click", function () {
                const input = btn.previousElementSibling;
                input.focus(); // open the date picker
              });
            });
          });
        </script>


        <button type="submit" class="btn btn-primary mt-3">Next</button>
        <br>
    </form>

    <br>
    <div class="progress mb-3">
        <div class="progress-bar" role="progressbar"
           style="width: {{ progress_percent }}%;"
           aria-valuenow="{{ progress_percent }}" aria-valuemin="0" aria-valuemax="100">
        {{ current_index }} of {{ total_questions }}
        </div>
    </div>
    {% if time_left %}
        <div id="survey-timer" class="alert alert-warning">
            Time left: <span id="survey-time">{{ time_left }}</span> seconds
        </div>
        <script>
          let surveyTime = {{ time_left }};
          const surveyInterval = setInterval(() => {
            surveyTime--;
            document.getElementById("survey-time").innerText = surveyTime;
            if (surveyTime <= 0) {
              clearInterval(surveyInterval);
              alert("Time is up! Submitting your survey.");
              window.location.href = "{% url 'surveys:survey_submit' survey.id %}";
            }
          }, 1000);
        </script>
    {% endif %}

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const map = L.map('map').setView([41.3275, 19.8189], 13); // default to Tirana

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let marker = null;

        function setLocation(lat, lng) {
          document.getElementById('locationInput').value = `${lat},${lng}`;
          document.getElementById('latitude').value = lat;
          document.getElementById('longitude').value = lng;
        }

        function addMarker(lat, lng) {
          if (marker) {
            map.removeLayer(marker);
          }
          marker = L.marker([lat, lng]).addTo(map);
          setLocation(lat, lng);
        }

        // Add marker on map click
        map.on('click', function (e) {
          const { lat, lng } = e.latlng;
          addMarker(lat, lng);
        });

        // Add geocoder control
        L.Control.geocoder({
            defaultMarkGeocode: false,
            placeholder: "Search for a location…",  // ✅ this adds the text
            collapsed: false  // ✅ Keep it always expanded
        })
        .on('markgeocode', function (e) {
          const latlng = e.geocode.center;
          map.setView(latlng, 15);
          addMarker(latlng.lat, latlng.lng);
        })
        .addTo(map);
      });
      // Move to top-left
    document.querySelector('.leaflet-control-geocoder').classList.add('leaflet-top', 'leaflet-left');
    </script>

</div>


{% endblock %}

