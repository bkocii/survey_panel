{% extends 'base.html' %}

{% block head_title %}
survey
{% endblock head_title %}


{% block content %}
<div class="container mt-5">
    <h2>{{ survey.title }}</h2>
    <p>{{ question.text }}</p>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        {% if question.question_type == 'MC' %}
            {% for choice in question.choices.all %}
                <label class="form-label">
                    <input type="radio" name="answer" value="{{ choice.id }}" required onchange="toggleOther(this)">
                    {{ choice.text }}
                </label><br>
            {% endfor %}

        {% elif question.question_type == 'DROPDOWN' %}
            <select name="answer" class="form-select" required onchange="toggleOther(this)">
                <option value="" disabled selected>-- Select an option --</option>
                {% for choice in question.choices.all %}
                    <option value="{{ choice.id }}">{{ choice.text }}</option>
                {% endfor %}
            </select>

        {% elif question.question_type == 'DATE' %}
            <div class="input-group">
                <input type="text" name="answer" class="form-control date-input" placeholder="Select a date">
                <button class="btn btn-outline-secondary calendar-btn" type="button">
                    <i class="bi bi-calendar"></i>
                </button>
            </div>

        {% elif question.question_type == 'YESNO' %}
            <label class="form-label me-3">
                <input type="radio" name="answer" value="yes" required>
                Yes
            </label>
            <label class="form-label">
                <input type="radio" name="answer" value="no" required>
                No
            </label>

        {% elif question.question_type == 'NUMBER' %}
            <input type="number" name="answer" class="form-control" required>

        {% elif question.question_type == 'SLIDER' %}
            <label for="slider">Value: <span id="slider-value">{{ question.min_value|default:0 }}</span></label>
            <input type="range"
                   name="answer"
                   id="slider"
                   class="form-range"
                   min="{{ question.min_value|default:0 }}"
                   max="{{ question.max_value|default:100 }}"
                   step="{{ question.step_value|default:1 }}"
                   value="{{ question.min_value|default:0 }}"
                   oninput="document.getElementById('slider-value').textContent = this.value">


        {% elif question.question_type == 'RATING' %}
            <div class="form-check form-check-inline">
                {% for choice in question.choices.all %}
                    <label class="form-check-label me-3">
                        <input type="radio" name="answer" value="{{ choice.id }}" required onchange="toggleOther(this)">
                        {{ choice.text }}
                    </label>
                {% endfor %}
            </div>

        {% elif question.question_type == 'MEDIA_UPLOAD' %}
            <label for="upload">Upload your photo or video:</label>
            <input type="file" name="answer_file" class="form-control" required>


        {% elif question.question_type == 'TEXT' %}
            <textarea class="form-control" name="answer" rows="4" required></textarea>


        {% elif question.question_type == 'MATRIX' %}
            <div class="matrix-block"
                 data-matrix-required="{{ question.required|yesno:'true,false' }}">

                {% if question.matrix_mode == 'side_by_side' %}
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Item</th>
                                {% for col in question.matrix_columns.all %}
                                    <th data-required="{{ col.required|yesno:'true,false' }}" data-col-index="{{ forloop.counter0 }}">
                                        {{ col.label }}
                                    </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in question.matrix_rows.all %}
                                <tr class="matrix-row"
                                    data-matrix-row
                                    data-required="{{ row.required|yesno:'true,false' }}">
                                    <td>{{ row.text }}</td>
                                    {% for col in question.matrix_columns.all %}
                                        <td class="text-center" data-col-index="{{ forloop.counter0 }}">
                                            {% if col.input_type == 'text' %}
                                                <input type="text" name="matrix_{{ row.id }}_{{ col.id }}"
                                                       class="form-control"
                                                       data-required="{{ col.required|yesno:'true,false' }}">
                                            {% elif col.input_type == 'select' %}
                                                <select name="matrix_{{ row.id }}_{{ col.id }}"
                                                        class="form-select"
                                                        data-required="{{ col.required|yesno:'true,false' }}">
                                                    <option value="">-- Choose --</option>
                                                    {% for option in col.dropdown_options %}
                                                        <option value="{{ option }}">{{ option }}</option>
                                                    {% endfor %}

                                                </select>
                                            {% elif col.input_type == 'radio' %}
                                                <input type="radio"
                                                       name="matrix_{{ row.id }}_{{ col.id }}"
                                                       value="yes"
                                                       data-required="{{ col.required|yesno:'true,false' }}">
                                            {% elif col.input_type == 'checkbox' %}
                                                <input type="checkbox"
                                                       name="matrix_{{ row.id }}_{{ col.id }}"
                                                       data-required="{{ col.required|yesno:'true,false' }}">
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% elif question.matrix_mode == 'multi' %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th></th>
                                {% for col in question.matrix_columns.all %}
                                    <th data-required="{{ col.required|yesno:'true,false' }}">{{ col.label }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in question.matrix_rows.all %}
                                <tr class="matrix-row"
                                    data-matrix-row
                                    data-required="{{ row.required|yesno:'true,false' }}">
                                    <td>{{ row.text }}</td>
                                    {% for col in question.matrix_columns.all %}
                                        <td>
                                            <input type="checkbox"
                                                   name="matrix_{{ row.id }}"
                                                   value="{{ col.id }}"
                                                   class="form-check-input"
                                                   data-required="{{ col.required|yesno:'true,false' }}">
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                {% else %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th></th>
                                {% for col in question.matrix_columns.all %}
                                    <th data-required="{{ col.required|yesno:'true,false' }}">{{ col.label }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in question.matrix_rows.all %}
                                <tr class="matrix-row"
                                    data-matrix-row
                                    data-required="{{ row.required|yesno:'true,false' }}">
                                    <td>{{ row.text }}</td>
                                    {% for col in question.matrix_columns.all %}
                                        <td>
                                            <input type="radio"
                                                   name="matrix_{{ row.id }}"
                                                   value="{{ col.id }}"
                                                   class="form-check-input"
                                                   data-required="{{ col.required|yesno:'true,false' }}">
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                      </table>
                {% endif %}
            </div>
        {% endif %}


                <!-- “Other” input field -->
        <div id="other-input" style="display: none;" class="mt-3">
            <label for="other_text">Please specify:</label>
            <input type="text" name="other_text" id="other_text" class="form-control">
        </div>

        <script>
        function toggleOther(input) {
            const otherDiv = document.getElementById('other-input');
            const selectedText = (
                input.tagName === 'SELECT'
                    ? input.options[input.selectedIndex].text
                    : input.nextSibling.textContent || ''
            ).trim().toLowerCase();

            if (selectedText === 'other') {
                otherDiv.style.display = 'block';
            } else {
                otherDiv.style.display = 'none';
                document.getElementById('other_text').value = '';
            }
        }
        </script>

        <script>
          document.addEventListener("DOMContentLoaded", function () {
            const fp = flatpickr(".date-input", {
              dateFormat: "Y-m-d"
            });

            document.querySelectorAll(".calendar-btn").forEach(btn => {
              btn.addEventListener("click", function () {
                const input = btn.previousElementSibling;
                input.focus(); // open the date picker
              });
            });
          });
        </script>


        <button type="submit" class="btn btn-primary mt-3">Next</button>
    </form>
    <br>
    <div class="progress mb-3">
        <div class="progress-bar" role="progressbar"
           style="width: {{ progress_percent }}%;"
           aria-valuenow="{{ progress_percent }}" aria-valuemin="0" aria-valuemax="100">
        {{ current_index }} of {{ total_questions }}
        </div>
    </div>
    {% if time_left %}
        <div id="survey-timer" class="alert alert-warning">
            Time left: <span id="survey-time">{{ time_left }}</span> seconds
        </div>
        <script>
          let surveyTime = {{ time_left }};
          const surveyInterval = setInterval(() => {
            surveyTime--;
            document.getElementById("survey-time").innerText = surveyTime;
            if (surveyTime <= 0) {
              clearInterval(surveyInterval);
              alert("Time is up! Submitting your survey.");
              window.location.href = "{% url 'surveys:survey_submit' survey.id %}";
            }
          }, 1000);
        </script>
    {% endif %}

</div>


{% endblock %}

