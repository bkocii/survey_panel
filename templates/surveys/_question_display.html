{# templates/surveys/_question_display.html #}
{# Context expects:#}
{#   question (Question),#}
{#   preview (bool),#}
{#   grouped_matrix_columns (dict)  # only needed for side_by_side#}
{##}

{% load custom_filters %}


{# SINGLE / MULTI CHOICE ------------------------------------------------- #}
{% if question.question_type == 'SINGLE_CHOICE' %}
  {% for choice in question.choices.all %}
    <label class="form-label d-block">
      <input
        type="radio"
        name="answer"
        value="{{ choice.id }}"
        onchange="toggleOther(this)"
        {% if question.required %}required{% endif %}
      >
      {{ choice.text }}
    </label>
  {% empty %}
    <div class="text-muted small">No choices added yet.</div>
  {% endfor %}

{% elif question.question_type == 'MULTI_CHOICE' %}
  {# HTML cannot truly “require at least one checkbox” — server validation handles it #}
  {% for choice in question.choices.all %}
    <label class="form-label d-block">
      <input
        type="checkbox"
        name="answer"
        value="{{ choice.id }}"
        onchange="toggleOther(this)"
      >
      {{ choice.text }}
    </label>
  {% empty %}
    <div class="text-muted small">No choices added yet.</div>
  {% endfor %}

{# GEOLOCATION ----------------------------------------------------------- #}
{% elif question.question_type == 'GEOLOCATION' %}
    {% if not preview %}
      <div id="map" style="height: 400px; width: 100%; margin-top: 1rem;"></div>
      <input type="hidden" name="location" id="locationInput">
      <input type="hidden" name="latitude" id="latitude">
      <input type="hidden" name="longitude" id="longitude">
    {% else %}
        <div class="border rounded p-3 text-muted small">Map preview</div>
      {% endif %}

{# DROPDOWN -------------------------------------------------------------- #}
{% elif question.question_type == 'DROPDOWN' %}
  <select
    name="answer"
    class="form-select"
    onchange="toggleOther(this)"
    {% if question.required %}required{% endif %}
  >
    <option value="" disabled selected>-- Select an option --</option>
    {% for choice in question.choices.all %}
      <option value="{{ choice.id }}">{{ choice.text }}</option>
    {% empty %}
      <option disabled>(no options)</option>
    {% endfor %}
  </select>

{# DATE ------------------------------------------------------------------ #}
{% elif question.question_type == 'DATE' %}
  <div class="input-group">
    <input
      type="text"
      name="answer"
      class="form-control date-input"
      placeholder="Select a date"
      {% if question.required %}required{% endif %}
    >
    <button class="btn btn-outline-secondary calendar-btn" type="button">
      <i class="bi bi-calendar"></i>
    </button>
  </div>

{# YES / NO -------------------------------------------------------------- #}
{% elif question.question_type == 'YESNO' %}
  <label class="form-label me-3">
    <input type="radio" name="answer" value="yes" {% if question.required %}required{% endif %}> Yes
  </label>
  <label class="form-label">
    <input type="radio" name="answer" value="no" {% if question.required %}required{% endif %}> No
  </label>

{# NUMBER ---------------------------------------------------------------- #}
{% elif question.question_type == 'NUMBER' %}
  <input type="number" name="answer" class="form-control" {% if question.required %}required{% endif %}>

{# SLIDER ---------------------------------------------------------------- #}
{% elif question.question_type == 'SLIDER' %}
  <label for="slider">
    Value: <span id="slider-value">{{ question.min_value|default:0 }}</span>
  </label>
  <input
    type="range"
    name="answer"
    id="slider"
    class="form-range"
    min="{{ question.min_value|default:0 }}"
    max="{{ question.max_value|default:100 }}"
    step="{{ question.step_value|default:1 }}"
    value="{{ question.min_value|default:0 }}"
    oninput="markSliderMoved(); document.getElementById('slider-value').textContent = this.value"
    {% if question.required %}required{% endif %}
  >
  <!-- tracks interaction so required sliders aren’t satisfied by default -->
  <input type="hidden" name="slider_moved" id="slider_moved" value="false">

{# RATING (text choices, not stars) ------------------------------------- #}
{% elif question.question_type == 'RATING' %}
  <div class="form-check form-check-inline">
    {% for choice in question.choices.all %}
      <label class="form-check-label me-3">
        <input
          type="radio"
          name="answer"
          value="{{ choice.id }}"
          onchange="toggleOther(this)"
          {% if question.required %}required{% endif %}
        >
        {{ choice.text }}
      </label>
    {% empty %}
      <span class="text-muted small">(no scale options)</span>
    {% endfor %}
  </div>

{# IMAGE RATING ---------------------------------------------------------- #}
{% elif question.question_type == 'IMAGE_RATING' %}
  <div class="image-rating-container">
    <div class="row">
      {% for choice in question.choices.all %}
        <div class="col-md-4 text-center mb-4">
          {% if choice.image %}
            <img src="{{ choice.image.url }}" class="img-thumbnail mb-2" alt="Image"
                 style="max-width: 100%; height: auto;">
          {% else %}
            <div class="border rounded mb-2 p-4 text-muted small">No image</div>
          {% endif %}

          <div class="mt-2 mb-2">
            {% for i in "12345" %}
              <div class="form-check form-check-inline">
                <input
                  class="form-check-input"
                  type="radio"
                  name="rating_{{ choice.id }}"
                  id="rating_{{ choice.id }}_{{ i }}"
                  value="{{ i }}"
                  {% if question.required %}required{% endif %}
                >
                <label class="form-check-label" for="rating_{{ choice.id }}_{{ i }}">{{ i }}</label>
              </div>
            {% endfor %}
          </div>
          <div class="form-choice-text">{{ choice.text }}</div>
        </div>
      {% empty %}
        <div class="text-muted small">No images to rate.</div>
      {% endfor %}
    </div>
  </div>

{# PHOTO / VIDEO / AUDIO UPLOAD ----------------------------------------- #}
{% elif question.question_type == 'PHOTO_UPLOAD' %}
  <label for="photo">Upload Photo:</label>
  <input
    type="file"
    id="photo"
    name="answer_file"
    class="form-control"
    accept="image/*"
    {% if question.allow_multiple_files %}multiple{% endif %}
    {% if question.required %}required{% endif %}
  >

{% elif question.question_type == 'VIDEO_UPLOAD' %}
  <label for="video">Upload Video:</label>
  <input
    type="file"
    id="video"
    name="answer_file"
    class="form-control"
    accept="video/*"
    {% if question.required %}required{% endif %}
  >

{% elif question.question_type == 'AUDIO_UPLOAD' %}
  <label for="audio">Upload Audio:</label>
  <input
    type="file"
    id="audio"
    name="answer_file"
    class="form-control"
    accept="audio/*"
    {% if question.required %}required{% endif %}
  >

{# TEXT ------------------------------------------------------------------ #}
{% elif question.question_type == 'TEXT' %}
  <textarea
    class="form-control"
    name="answer"
    rows="4"
    {% if question.required %}required{% endif %}
  ></textarea>

{# IMAGE CHOICE ---------------------------------------------------------- #}
{% elif question.question_type == 'IMAGE_CHOICE' %}
  <div class="image-choice-container">
    <div class="row">
      {% for choice in question.choices.all %}
        <div class="col-md-3 text-center mb-4">
          <label class="image-choice-label" style="cursor: pointer;">
            <div class="form-check">
              {% if question.allows_multiple %}
                <input
                  type="checkbox"
                  name="answer"
                  value="{{ choice.id }}"
                  class="form-check-input me-2"
                  onchange="highlightSelected(this)"
                >
              {% else %}
                <input
                  type="radio"
                  name="answer"
                  value="{{ choice.id }}"
                  class="form-check-input me-2"
                  onchange="highlightSelected(this)"
                  {% if question.required %}required{% endif %}
                >
              {% endif %}
            </div>

            {% if choice.image %}
              <img src="{{ choice.image.url }}" class="img-thumbnail img-select mt-2"
                   data-choice-id="{{ choice.id }}" alt="Option">
            {% else %}
              <div class="border rounded mt-2 p-4 text-muted small">No image</div>
            {% endif %}
            <div class="mt-2">{{ choice.text }}</div>
          </label>
        </div>
      {% empty %}
        <div class="text-muted small px-3">No image choices added yet.</div>
      {% endfor %}
    </div>
  </div>

{# MATRIX ---------------------------------------------------------------- #}
{% elif question.question_type == 'MATRIX' %}
  <div class="matrix-block"
       data-matrix-required="{{ question.required|yesno:'true,false' }}">

    {% if question.matrix_mode == 'side_by_side' %}
      <table class="table table-bordered align-middle">
        <thead>
          <tr>
            <th rowspan="2" class="align-middle">Item</th>
            {% for group, cols in grouped_matrix_columns.items %}
              <th colspan="1" class="text-center align-middle">{{ group }}</th>
            {% endfor %}
          </tr>
          <tr>
            {% for group, cols in grouped_matrix_columns.items %}
              <th class="text-center">
                {% if cols.0.input_type == 'radio' or cols.0.input_type == 'checkbox' %}
                  <div class="d-flex justify-content-around">
                    {% for col in cols %}
                      <span class="small text-nowrap">{{ col.label }}</span>
                    {% endfor %}
                  </div>
                {% else %}
                  &nbsp;
                {% endif %}
              </th>
            {% endfor %}
          </tr>
        </thead>

        <tbody>
          {% for row in question.matrix_rows.all %}
            <tr>
              <td>{{ row.text }}</td>

              {% for group, cols in grouped_matrix_columns.items %}
                {% if cols.0.input_type == 'text' %}
                  {# one text input per group #}
                  {% with row.id|concat_ids:cols.0.id as field_name %}
                    <td>
                      <input
                        type="text"
                        name="{{ field_name }}"
                        value="{% if submitted_data %}{{ submitted_data|get_item:field_name }}{% endif %}"
                        class="form-control">
                    </td>
                  {% endwith %}

                {% elif cols.0.input_type == 'select' %}
                  {% with group_slug=group|slugify %}
                    {% with row.id|stringformat:"s"|add:"_"|add:group_slug as field_name %}
                      {% with "matrix_"|add:field_name as full_field_name %}
                        <td>
                          <select
                            name="{{ full_field_name }}"
                            class="form-select">
                            <option value="">-- Choose --</option>
                            {% for col in cols %}
                              <option value="{{ col.value }}"
                                {% if submitted_data|get_item:full_field_name == col.value|stringformat:"s" %}selected{% endif %}
                              >
                                {{ col.label }}
                              </option>
                            {% endfor %}
                          </select>
                        </td>
                      {% endwith %}
                    {% endwith %}
                  {% endwith %}

                {% elif cols.0.input_type == 'radio' %}
                  {% with group_slug=group|slugify %}
                    {% with row.id|stringformat:"s"|add:"_"|add:group_slug as field_name %}
                      {% with radio_name="matrix_"|add:field_name %}
                        <td class="align-middle">
                          <div class="d-flex justify-content-around">
                            {% for col in cols %}
                              <div class="form-check form-check-inline">
                                <input
                                  type="radio"
                                  name="{{ radio_name }}"
                                  value="{{ col.value }}"
                                  {% if submitted_data|get_item:radio_name == col.value|stringformat:"s" %}checked{% endif %}
                                  class="form-check-input"
                                  id="radio_{{ row.id }}_{{ col.id }}">
                              </div>
                            {% endfor %}
                          </div>
                        </td>
                      {% endwith %}
                    {% endwith %}
                  {% endwith %}

                {% elif cols.0.input_type == 'checkbox' %}
                  {% with group_slug=group|slugify %}
                    {% with row.id|stringformat:"s"|add:"_"|add:group_slug as field_name %}
                      {% with checkbox_name="matrix_"|add:field_name %}
                        <td class="align-middle">
                          <div class="d-flex justify-content-around">
                            {% for col in cols %}
                              <div class="form-check form-check-inline">
                                <input
                                  type="checkbox"
                                  name="{{ checkbox_name }}"
                                  value="{{ col.value }}"
                                  {% if col.value|stringformat:"s" in submitted_data|get_list:checkbox_name %}checked{% endif %}
                                  class="form-check-input"
                                  id="checkbox_{{ row.id }}_{{ col.id }}"
                                >
                              </div>
                            {% endfor %}
                          </div>
                        </td>
                      {% endwith %}
                    {% endwith %}
                  {% endwith %}
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {% elif question.matrix_mode == 'multi' %}
      <table class="table">
        <thead>
          <tr>
            <th></th>
            {% for col in question.matrix_columns.all %}
              <th>{{ col.label }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in question.matrix_rows.all %}
            <tr>
              <td>{{ row.text }}</td>
              {% for col in question.matrix_columns.all %}
                <td>
                  {% with row.id|concat_ids:col.id as field_name %}
                    <div class="form-check">
                      <input
                        type="checkbox"
                        name="{{ field_name }}"
                        value="{{ col.value }}"
                        {% if submitted_data|get_item:field_name == col.value|stringformat:"s" %}checked{% endif %}
                        class="form-check-input"
                        id="checkbox_{{ row.id }}_{{ col.id }}"
                      >
                    </div>
                  {% endwith %}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {% else %}
      {# default: single select per row #}
      <table class="table">
        <thead>
          <tr>
            <th></th>
            {% for col in question.matrix_columns.all %}
              <th>{{ col.label }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in question.matrix_rows.all %}
            <tr>
              <td>{{ row.text }}</td>
              {% with row_id_str=row.id|stringformat:"s" %}
                {% with row_name="matrix_"|add:row_id_str %}
                  {% for col in question.matrix_columns.all %}
                    <td>
                      <input
                        type="radio"
                        name="{{ row_name }}"
                        value="{{ col.value }}"
                        {% if submitted_data|get_item:row_name == col.value|stringformat:"s" %}checked{% endif %}
                        class="form-check-input"
                        id="radio_{{ row.id }}_{{ col.id }}">
                    </td>
                  {% endfor %}
                {% endwith %}
              {% endwith %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>
{% endif %}
