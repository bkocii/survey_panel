{% extends "users/dashboard_base.html" %}

{% block head_title %}Dashboard{% endblock head_title %}
{% block page_title %}Dashboard{% endblock page_title %}

{% block content %}

<!-- Profile + Stats -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">

  <!-- User card -->
  <div class="card bg-slate-900/60 border border-slate-800 p-5">
    <div class="flex items-center gap-4">
      <div class="w-16 h-16 rounded-full overflow-hidden bg-slate-800 border border-slate-700">
        {% if request.user.avatar %}
          <img src="{{ request.user.avatar.url }}" class="w-full h-full object-cover" alt="Avatar">
        {% endif %}
      </div>
      <div>
        <div class="font-semibold text-lg">
          {{ request.user.get_full_name|default:request.user.username }}
        </div>
        <div class="text-slate-400 text-sm">{{ request.user.email }}</div>
        <div class="text-slate-500 text-xs mt-1">
          Last submission:
          {% if stats.last_submitted_at %}
            {{ stats.last_submitted_at|date:"Y-m-d H:i" }}
          {% else %}
            -
          {% endif %}
        </div>
      </div>
    </div>

    <div class="mt-4 flex gap-2">
      <a class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm transition"
         href="{% url 'rewards:my_redemptions' %}">
        My redemptions
      </a>
      <a class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm transition"
         href="{% url 'surveys:survey_list' %}">
        Survey list
      </a>
    </div>
  </div>

  <!-- Stats cards -->
  <div class="lg:col-span-2 grid grid-cols-2 md:grid-cols-4 gap-4">
    <div class="card bg-slate-900/60 border border-slate-800 p-4">
      <div class="text-slate-400 text-xs">Available surveys</div>
      <div class="text-2xl font-semibold mt-1">{{ stats.available_count }}</div>
    </div>
    <div class="card bg-slate-900/60 border border-slate-800 p-4">
      <div class="text-slate-400 text-xs">Completed surveys</div>
      <div class="text-2xl font-semibold mt-1">{{ stats.completed_count }}</div>
    </div>
    <div class="card bg-slate-900/60 border border-slate-800 p-4">
      <div class="text-slate-400 text-xs">Points</div>
      <div class="text-2xl font-semibold mt-1">{{ stats.points }}</div>
    </div>
    <div class="card bg-slate-900/60 border border-slate-800 p-4">
      <div class="text-slate-400 text-xs">Support</div>
      <div class="text-sm text-slate-300 mt-2">Tickets soon</div>
      <div class="text-xs text-slate-500">Email support for now</div>
    </div>
  </div>
</div>

<!-- Surveys -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">

  <!-- Available -->
  <div class="card bg-slate-900/60 border border-slate-800 p-5">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold">Available surveys</h2>
      <a class="text-sm text-indigo-400 hover:text-indigo-300"
         href="{% url 'surveys:survey_list' %}">
        View all
      </a>
    </div>

    <div class="space-y-3">
      {% for s in available_surveys %}
        <div class="p-4 rounded-2xl border border-slate-800 bg-slate-950/50">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-medium">{{ s.title }}</div>
              <div class="text-slate-400 text-sm">{{ s.description|truncatewords:18 }}</div>
              <div class="text-slate-500 text-xs mt-1">
                Reward: {{ s.points_reward }} pts
                {% if s.time_limit_minutes %} • Time: {{ s.time_limit_minutes }} min{% endif %}
              </div>
            </div>

            {# IMPORTANT: change this URL name to your actual survey start/detail route #}
            <a href="{% url 'surveys:survey_start' s.id %}"
               class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-sm transition">
              Start
            </a>
          </div>
        </div>
      {% empty %}
        <div class="text-slate-400 text-sm">No surveys available right now.</div>
      {% endfor %}
    </div>
  </div>

  <!-- Completed -->
  <div class="card bg-slate-900/60 border border-slate-800 p-5">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold">Completed surveys</h2>
      <span class="text-xs text-slate-500">Read-only</span>
    </div>

    <div class="space-y-3">
      {% for sub in completed_surveys %}
        <button type="button"
                class="w-full text-left p-4 rounded-2xl border border-slate-800 bg-slate-950/50 hover:bg-slate-900 transition"
                onclick="alert('This survey is already submitted.');">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-medium flex items-center gap-2">
                {{ sub.survey.title }}
                <span class="text-xs px-2 py-1 rounded-full bg-slate-800 text-slate-200">
                  Completed
                </span>
              </div>
              <div class="text-slate-400 text-sm">
                Submitted: {{ sub.submitted_at|date:"Y-m-d H:i" }}
              </div>
            </div>
            <div class="text-yellow-400 text-lg">⚠</div>
          </div>
        </button>
      {% empty %}
        <div class="text-slate-400 text-sm">No completed surveys yet.</div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Rewards + Redemptions -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

  <!-- Featured prizes -->
  <div class="lg:col-span-2 card bg-slate-900/60 border border-slate-800 p-5">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold">Featured prizes</h2>
      <a class="text-sm text-indigo-400 hover:text-indigo-300"
         href="{% url 'rewards:prize_list' %}">
        Browse prizes
      </a>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      {% for p in featured_prizes %}
        <a href="{% url 'rewards:prize_detail' p.id %}"
           class="p-4 rounded-2xl border border-slate-800 bg-slate-950/50 hover:bg-slate-900 transition block">
          <div class="font-medium">{{ p.name }}</div>
          <div class="text-slate-400 text-sm">{{ p.description|truncatewords:12 }}</div>
          <div class="text-indigo-300 text-sm mt-2">{{ p.points_cost }} pts</div>
          <div class="text-slate-500 text-xs mt-1">
            {% if p.stock is None %}Stock: unlimited{% else %}Stock: {{ p.stock }}{% endif %}
          </div>
        </a>
      {% empty %}
        <div class="text-slate-400 text-sm">No prizes yet.</div>
      {% endfor %}
    </div>
  </div>

  <!-- Recent redemptions + support -->
  <div class="card bg-slate-900/60 border border-slate-800 p-5">
    <h2 class="font-semibold mb-3">Recent redemptions</h2>

    <div class="space-y-2 mb-4">
      {% for r in recent_redemptions %}
        <div class="p-3 rounded-2xl border border-slate-800 bg-slate-950/50">
          <div class="text-sm font-medium">{{ r.prize.name }}</div>
          <div class="text-xs text-slate-400">
            {{ r.created_at|date:"Y-m-d H:i" }} • {{ r.get_status_display }}
          </div>
        </div>
      {% empty %}
        <div class="text-slate-400 text-sm">No redemptions yet.</div>
      {% endfor %}
    </div>

    <h3 class="font-semibold mb-2">Support</h3>
    <div class="space-y-2">

      <a class="block px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 transition text-sm"
         href="{% url 'support:ticket_list' %}">
        My tickets
      </a>
      <a class="block px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 transition text-sm"
         href="{% url 'support:ticket_create' %}">
        Open a ticket
      </a>
      <a class="block px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 transition text-sm"
         href="mailto:support@yourdomain.com">
        Email support
      </a>
      <div class="text-xs text-slate-500">
        Tickets section will be added in the next step.
      </div>
    </div>
  </div>

</div>

{% endblock %}